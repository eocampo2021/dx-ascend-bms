<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>DX-Ascend Runtime</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top left, #1d2733, #0b0d12);
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      overflow: hidden;
    }
    #screen-root {
      position: relative;
      width: 100vw;
      height: 100vh;
      padding: 16px;
    }
    #loading {
      position: absolute;
      left: 16px;
      top: 16px;
      font-size: 14px;
      opacity: 0.8;
    }
    .screen-title {
      position: absolute;
      left: 16px;
      top: 10px;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-shadow: 0 0 18px rgba(0, 245, 199, 0.55);
    }

    /* ---------- Widgets glass / glow ---------- */

    .widget {
      position: absolute;
      border-radius: 16px;
      padding: 6px 10px 12px 10px;
      background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.04),
          rgba(0, 0, 0, 0.55)
        ),
        radial-gradient(circle at top left, rgba(0, 245, 199, 0.18), transparent 60%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.75),
        0 0 18px rgba(0, 245, 199, 0.15);
      backdrop-filter: blur(14px);
      overflow: hidden;
    }
    .widget-title {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.72;
    }
    .widget-value {
      font-size: 22px;
      font-weight: 600;
      margin-top: 4px;
      text-shadow: 0 0 8px rgba(0, 245, 199, 0.55);
      white-space: nowrap;
    }
    .widget-mode {
      position: absolute;
      right: 8px;
      top: 6px;
      font-size: 10px;
      opacity: 0.55;
    }

    /* ---------- Barra (lineal) ---------- */

    .bar-bg {
      position: absolute;
      left: 10px;
      right: 10px;
      bottom: 10px;
      height: 10px;
      border-radius: 999px;
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.25), transparent 70%),
        rgba(255, 255, 255, 0.04);
      overflow: hidden;
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.7);
    }
    .bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #00f5c7, #3bf57a, #9eff57);
      width: 50%;
      box-shadow:
        0 0 16px rgba(0, 245, 199, 0.9),
        0 0 28px rgba(59, 245, 122, 0.8);
      transform-origin: left center;
      transition: width 0.25s ease-out;
    }

    /* ---------- Indicator ON/OFF ---------- */

    .widget-indicator {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      margin-top: 4px;
      box-shadow:
        0 0 14px rgba(0, 0, 0, 0.9),
        0 0 10px rgba(0, 245, 199, 0.45);
    }

    /* ---------- Gauge circular ---------- */

    .gauge-shell {
      position: absolute;
      left: 50%;
      top: 55%;
      width: 78%;
      height: 78%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #1b2c38, #050608);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.9),
        0 0 26px rgba(0, 245, 199, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      overflow: hidden;
    }
    .gauge-arc {
      position: absolute;
      left: 6%;
      top: 6%;
      right: 6%;
      bottom: 6%;
      border-radius: 50%;
      border: 7px solid rgba(255, 255, 255, 0.06);
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8);
      mask-image: conic-gradient(
        transparent 225deg,
        black 225deg,
        black 495deg,
        transparent 495deg
      );
      -webkit-mask-image: conic-gradient(
        transparent 225deg,
        black 225deg,
        black 495deg,
        transparent 495deg
      );
    }
    .gauge-arc-fill {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: conic-gradient(
        #00f5c7 0deg,
        #3bf57a 120deg,
        #9eff57 240deg,
        rgba(255, 255, 255, 0.1) 270deg
      );
      transform-origin: 50% 50%;
      transform: rotate(-135deg);
      filter: drop-shadow(0 0 12px rgba(0, 245, 199, 0.9));
      mask-image: conic-gradient(
        transparent 225deg,
        black 225deg,
        black 495deg,
        transparent 495deg
      );
      -webkit-mask-image: conic-gradient(
        transparent 225deg,
        black 225deg,
        black 495deg,
        transparent 495deg
      );
      transition: transform 0.25s ease-out;
    }
    .gauge-center {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle, #00f5c7, #00443a);
      box-shadow:
        0 0 12px rgba(0, 245, 199, 0.9),
        0 0 30px rgba(59, 245, 122, 0.8);
    }
    .gauge-needle {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 2px;
      height: 40%;
      transform-origin: 50% 90%;
      background: linear-gradient(#fdfdfd, #00f5c7);
      box-shadow: 0 0 10px rgba(0, 245, 199, 0.9);
      transform: translate(-50%, -90%) rotate(-135deg);
      transition: transform 0.25s ease-out;
    }
    .gauge-label {
      position: absolute;
      left: 50%;
      bottom: 10%;
      transform: translateX(-50%);
      font-size: 11px;
      opacity: 0.75;
    }

    /* ---------- Ícono de ventilador ---------- */

    .fan-wrapper {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .fan-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: radial-gradient(circle at 30% 20%, #1f313e, #050608);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 10px 24px rgba(0, 0, 0, 0.9),
        0 0 16px rgba(0, 245, 199, 0.45);
    }
    .fan-rotor {
      position: relative;
      width: 70%;
      height: 70%;
      border-radius: 50%;
      background: radial-gradient(circle, #ffffff, #00f5c7);
      box-shadow: 0 0 10px rgba(0, 245, 199, 0.8);
      overflow: visible;
    }
    .fan-blade {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 10px;
      height: 60%;
      transform-origin: 50% 100%;
      border-radius: 999px;
      background: linear-gradient(#ffffff, #00f5c7);
      box-shadow: 0 0 8px rgba(0, 245, 199, 0.9);
    }
    .fan-blade:nth-child(1) { transform: translate(-50%, -100%) rotate(0deg); }
    .fan-blade:nth-child(2) { transform: translate(-50%, -100%) rotate(120deg); }
    .fan-blade:nth-child(3) { transform: translate(-50%, -100%) rotate(240deg); }

    @keyframes spin-blades {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }
    .fan-rotor.spin {
      animation: spin-blades 0.8s linear infinite;
    }
    .fan-text {
      font-size: 13px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div id="screen-root">
    <div id="loading">Cargando pantalla...</div>
  </div>

  <script>
    // ---- Utilidades de rango / decimales según unidad ----
    function inferRange(widget, binding) {
      let min = widget.config && typeof widget.config.min === "number" ? widget.config.min : null;
      let max = widget.config && typeof widget.config.max === "number" ? widget.config.max : null;

      const dp = binding && binding.datapoint ? binding.datapoint : null;
      const unit = (dp && dp.unit ? dp.unit : "").toString().toLowerCase();
      const name = (dp && dp.name ? dp.name : widget.name || "").toString().toLowerCase();

      if (min === null || max === null) {
        if (unit.includes("%")) {
          if (min === null) min = 0;
          if (max === null) max = 100;
        } else if (unit.includes("°c") || unit.includes(" c") || name.includes("temp")) {
          if (min === null) min = 0;
          if (max === null) max = 40;
        } else {
          if (min === null) min = 0;
          if (max === null) max = 100;
        }
      }
      if (max === min) {
        max = min + 1;
      }
      return { min, max };
    }

    function inferDecimals(widget, binding) {
      if (widget.config && typeof widget.config.decimals === "number") {
        return widget.config.decimals;
      }
      const dp = binding && binding.datapoint ? binding.datapoint : null;
      const unit = (dp && dp.unit ? dp.unit : "").toString().toLowerCase();
      if (unit.includes("%")) return 0;
      if (unit.includes("°c") || unit.includes(" c")) return 1;
      return 2;
    }

    async function main() {
      const loadingEl = document.getElementById("loading");
      const { screenId, screenRoute } = parseUrlForScreen();

      if (!screenId && !screenRoute) {
        loadingEl.textContent =
          "Falta pantalla en la URL. Usa /web/NombrePantalla o /runtime/1";
        return;
      }

      try {
        const res = screenId
          ? await fetch("/api/runtime/screen/" + screenId)
          : await fetch(
              "/api/runtime/screen-by-route?route=" +
                encodeURIComponent(screenRoute || "")
            );
        if (!res.ok) {
          loadingEl.textContent =
            "Error al obtener pantalla: HTTP " + res.status;
          return;
        }
        const data = await res.json();
        renderScreen(data);
        startAutoRefresh({ screenId, screenRoute });
      } catch (e) {
        loadingEl.textContent = "Error: " + e;
      }
    }

    function parseUrlForScreen() {
      // /runtime/1 => id, /web/NombrePantalla => route/name
      const runtimeMatch = window.location.pathname.match(/\/runtime\/(\d+)/);
      if (runtimeMatch) {
        return { screenId: runtimeMatch[1], screenRoute: null };
      }

      const webMatch = window.location.pathname.match(/\/web\/([^/]+)/);
      if (webMatch) {
        return { screenId: null, screenRoute: decodeURIComponent(webMatch[1]) };
      }

      return { screenId: null, screenRoute: null };
    }

    function renderScreen(data) {
      const root = document.getElementById("screen-root");
      root.innerHTML = "";

      const title = document.createElement("div");
      title.className = "screen-title";
      title.textContent =
        data.screen.name + (data.screen.route ? "  " + data.screen.route : "");
      root.appendChild(title);

      const offsetY = 40; // bajamos todo un poco para que el título no tape

      for (const w of data.widgets) {
        const el = document.createElement("div");
        el.className = "widget";

        el.style.left = (w.x || 0) + "px";
        el.style.top = ((w.y || 0) + offsetY) + "px";
        el.style.width = (w.width || 120) + "px";
        el.style.height = (w.height || 80) + "px";

        const titleEl = document.createElement("div");
        titleEl.className = "widget-title";
        titleEl.textContent = w.name + " [" + w.type.toUpperCase() + "]";
        el.appendChild(titleEl);

        const modeEl = document.createElement("div");
        modeEl.className = "widget-mode";

        const binding = w.bindings && w.bindings[0];
        if (binding) {
          modeEl.textContent = binding.mode || "";
        } else {
          modeEl.textContent = "no bind";
        }
        el.appendChild(modeEl);

        const valEl = document.createElement("div");
        valEl.className = "widget-value";

        if (binding) {
          if (typeof binding.value === "number") {
            const unit = binding.datapoint && binding.datapoint.unit
              ? binding.datapoint.unit
              : "";
            const decimals = inferDecimals(w, binding);
            valEl.textContent =
              binding.value.toFixed(decimals) +
              (unit ? " " + unit : "");
          } else {
            valEl.textContent = binding.value ? "ON" : "OFF";
          }
        } else {
          valEl.textContent = "(sin binding)";
        }

        el.appendChild(valEl);

        /* ---------- Tipos ---------- */

        // Barra lineal
        if (w.type === "bar" && binding && typeof binding.value === "number") {
          const barBg = document.createElement("div");
          barBg.className = "bar-bg";

          const barFill = document.createElement("div");
          barFill.className = "bar-fill";

          const range = inferRange(w, binding);
          const pct = Math.max(
            0,
            Math.min(1, (binding.value - range.min) / (range.max - range.min || 1))
          );

          barFill.style.width = (pct * 100).toFixed(1) + "%";

          barBg.appendChild(barFill);
          el.appendChild(barBg);
        }

        // Indicator ON/OFF
        if (w.type === "indicator" && binding) {
          const ind = document.createElement("div");
          ind.className = "widget-indicator";
          const on = !!binding.value;
          ind.style.background = on
            ? "radial-gradient(circle, #3bf57a 0%, #029f54 60%, #00361c 100%)"
            : "radial-gradient(circle, #555 0%, #222 60%, #000 100%)";
          el.appendChild(ind);
        }

        // Gauge circular
        if (w.type === "gauge" && binding && typeof binding.value === "number") {
          const range = inferRange(w, binding);
          const pct = Math.max(
            0,
            Math.min(1, (binding.value - range.min) / (range.max - range.min || 1))
          );
          const angle = -135 + pct * 270; // -135° a +135°

          const shell = document.createElement("div");
          shell.className = "gauge-shell";

          const arc = document.createElement("div");
          arc.className = "gauge-arc";

          const arcFill = document.createElement("div");
          arcFill.className = "gauge-arc-fill";
          arcFill.style.transform = "rotate(" + (-135 + pct * 270) + "deg)";

          const center = document.createElement("div");
          center.className = "gauge-center";

          const needle = document.createElement("div");
          needle.className = "gauge-needle";
          needle.style.transform =
            "translate(-50%, -90%) rotate(" + angle + "deg)";

          const label = document.createElement("div");
          label.className = "gauge-label";
          const unit =
            binding.datapoint && binding.datapoint.unit
              ? binding.datapoint.unit
              : "";
          const decimals = inferDecimals(w, binding);
          label.textContent =
            binding.value.toFixed(decimals) + (unit ? " " + unit : "");

          shell.appendChild(arcFill);
          shell.appendChild(arc);
          shell.appendChild(needle);
          shell.appendChild(center);
          shell.appendChild(label);

          el.appendChild(shell);
        }

        // Ventilador (fan)
        if (w.type === "fan" && binding) {
          const wrapper = document.createElement("div");
          wrapper.className = "fan-wrapper";

          const icon = document.createElement("div");
          icon.className = "fan-icon";

          const rotor = document.createElement("div");
          rotor.className = "fan-rotor";
          const on = !!binding.value;
          if (on) {
            rotor.classList.add("spin");
          }

          for (let i = 0; i < 3; i++) {
            const blade = document.createElement("div");
            blade.className = "fan-blade";
            rotor.appendChild(blade);
          }

          icon.appendChild(rotor);
          wrapper.appendChild(icon);

          const txt = document.createElement("div");
          txt.className = "fan-text";
          txt.textContent = on ? "Ventilador ON" : "Ventilador OFF";
          wrapper.appendChild(txt);

          el.appendChild(wrapper);
        }

        root.appendChild(el);
      }
    }

    function startAutoRefresh({ screenId, screenRoute }) {
      setInterval(async () => {
        try {
          const res = screenId
            ? await fetch("/api/runtime/screen/" + screenId)
            : await fetch(
                "/api/runtime/screen-by-route?route=" +
                  encodeURIComponent(screenRoute || "")
              );
          if (!res.ok) return;
          const data = await res.json();
          renderScreen(data);
        } catch (e) {
          console.warn("Auto-refresh error", e);
        }
      }, 2000); // refresco cada 2s
    }

    main().catch((err) => {
      const loadingEl = document.getElementById("loading");
      if (loadingEl) loadingEl.textContent = "Error fatal: " + err;
    });
  </script>
</body>
</html>
